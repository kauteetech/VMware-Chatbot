# VMware Data Collector Application

This application provides a FastAPI-based API to collect and serve real-time VMware vSphere, vSAN, and SDDC Manager data using `rvtools-python`. It includes a web-based Admin UI for configuration and data collection, and exposes API endpoints for programmatic access, making it suitable for integration with other tools, including Large Language Models (LLMs).

## Table of Contents

1. [Application Overview](https://www.google.com/search?q=%23application-overview)

2. [Features](https://www.google.com/search?q=%23features)

3. [Architecture & Flow of Sequence](https://www.google.com/search?q=%23architecture--flow-of-sequence)

   * [Components](https://www.google.com/search?q=%23components)

   * [Process Flow](https://www.google.com/search?q=%23process-flow)

4. [Major Libraries Involved](https://www.google.com/search?q=%23major-libraries-involved)

5. [Setup & Installation](https://www.google.com/search?q=%23setup--installation)

   * [Prerequisites](https://www.google.com/search?q=%23prerequisites)

   * [Clone the Repository](https://www.google.com/search?q=%23clone-the-repository)

   * [Create `app` Directory](https://www.google.com/search?q=%23create-app-directory)

   * [Create `templates` Directory](https://www.google.com/search?q=%23create-templates-directory)

   * [Create `requirements.txt`](https://www.google.com/search?q=%23create-requirements.txt)

   * [Create `Dockerfile`](https://www.google.com/search?q=%23create-dockerfile)

   * [Create `.env` File](https://www.google.com/search?q=%23create-env-file)

   * [Build the Podman Image](https://www.google.com/search?q=%23build-the-podman-image)

   * [Run the Podman Container](https://www.google.com/search?q=%23run-the-podman-container)

6. [How to Use the Tool](https://www.google.com/search?q=%23how-to-use-the-tool)

   * [Admin UI](https://www.google.com/search?q=%23admin-ui)

   * [API Endpoints](https://www.google.com/search?q=%23api-endpoints)

   * [Authentication](https://www.google.com/search?q=%23authentication)

7. [Troubleshooting](https://www.google.com/search?q=%23troubleshooting)

## 1. Application Overview

This project sets up a containerized FastAPI application that acts as an intermediary for collecting VMware inventory data and exposing it via a RESTful API. It leverages the `rvtools-python` command-line tool to perform the actual data extraction from vCenter Server. The collected data (initially CSVs) is processed and served in a more consumable JSON format. An administrative web interface is provided for easy configuration and triggering of data collection.

## 2. Features

* **vCenter Data Collection:** Integrates with `rvtools-python` to gather comprehensive VMware inventory data (VMs, Hosts, Datastores, Clusters, Networks, etc.).

* **Web-based Admin UI:** A simple HTML interface to:

  * Configure vCenter connection credentials.

  * Trigger manual data collection.

  * View real-time application logs for monitoring and troubleshooting.

* **RESTful API:** Exposes collected VMware data through authenticated API endpoints.

* **OAuth2 Authentication (JWT):** Secures API access using JSON Web Tokens.

* **Containerized Deployment:** Uses Podman (or Docker) for isolated, portable, and consistent deployment.

* **Data Transformation:** Automatically converts raw CSV data from `rvtools-python` into a column-wise JSON format optimized for API consumption.

* **Interactive Architecture Explanation:** A built-in help modal in the Admin UI explains the application's architecture, components, and data flow.

## 3. Architecture & Flow of Sequence

The application follows a client-server architecture, with a containerized backend interacting with external VMware systems and serving data to various consumers.

### Components

* **vCenter Server:** The source of truth for VMware inventory data. An external system that the application connects to.

* **Podman Container:** The isolated runtime environment for the entire application. It encapsulates the FastAPI app, `rvtools-python`, and all data/config files.

* **FastAPI App (`main.py`):**

  * The core backend logic.

  * Serves the Admin UI (`admin.html`).

  * Exposes RESTful API endpoints for data retrieval.

  * Manages vCenter configuration (reads/writes `config.ini`).

  * Triggers and orchestrates `rvtools-python` data collection.

  * Transforms `vinfo.csv` into `vinfo.json`.

  * Handles authentication and logging (`app.log`).

* **`rvtools-python` (External Tool):** A Python command-line utility executed by the FastAPI app to connect to vCenter and extract data into CSV files.

* **`config.ini`:** A configuration file storing vCenter credentials and output paths. Managed by the FastAPI app.

* **`vinfo.csv` (and other CSVs):** Raw data files generated by `rvtools-python`. These are intermediate files.

* **`vinfo.json` (and other JSONs):** Processed, column-wise JSON files derived from CSVs, optimized for efficient API querying. This is the primary data source for API consumers.

* **`app.log`:** The application's log file, recording all events, warnings, and errors from the FastAPI app.

* **Admin UI (`admin.html`):** The web interface for administrators to interact with the application.

* **LLM / API Consumers:** Any external applications (e.g., Large Language Models, dashboards, scripts) that consume data from the FastAPI API.

### Process Flow

Here's a high-level sequence of how data is collected and served:

1. **Admin User Configuration:** An administrator accesses the **Admin UI** (`admin.html`), inputs **vCenter Server** credentials and an output directory, and saves this configuration. The **FastAPI App** writes this to `config.ini`.

2. **Data Collection Trigger:** The Admin User clicks "Collect Data Now" in the **Admin UI**. This sends a request to the **FastAPI App**.

3. **`rvtools-python` Execution:** The **FastAPI App** reads the credentials from `config.ini` and executes the `rvtools-python` command, passing the vCenter details.

4. **Data Extraction:** `rvtools-python` connects to the **vCenter Server**, collects the raw inventory data, and writes it to CSV files (e.g., `vinfo.csv`, `hosts.csv`) within the specified data directory inside the **Podman Container**.

5. **Data Transformation:** After `rvtools-python` completes, the **FastAPI App** reads the generated CSV files (e.g., `vinfo.csv`), processes them (sanitizing column names, converting to column-wise format), and saves the refined data into JSON files (e.g., `vinfo.json`).

6. **Logging:** Throughout these operations, the **FastAPI App** writes detailed logs to `app.log`.

7. **Log Viewing:** The Admin User can refresh the logs in the **Admin UI**, which triggers the **FastAPI App** to read and return the contents of `app.log`.

8. **API Consumption:** **LLM / API Consumers** make authenticated HTTP requests to the **FastAPI App**'s API endpoints.

9. **Data Serving:** The **FastAPI App** reads the relevant data directly from the processed JSON files (e.g., `vinfo.json`) and returns it as a JSON response to the **LLM / API Consumers**.

## 4. Major Libraries Involved

This application relies on several key Python libraries:

* **FastAPI:** The web framework for building the API and serving HTML. Chosen for its speed, modern features, and automatic documentation.

* **Uvicorn:** An ASGI server that runs the FastAPI application.

* **Pydantic:** Used by FastAPI for data validation, serialization, and automatic OpenAPI schema generation.

* **`python-jose[cryptography]`:** For handling JSON Web Tokens (JWTs) for authentication.

* **`passlib[bcrypt]`:** For secure password hashing and verification.

* **`python-dotenv`:** To load environment variables from a `.env` file, keeping sensitive information out of the codebase.

* **`pandas`:** Essential for reading, processing, and transforming CSV data into a more structured format (like column-wise JSON).

* **`rvtools-python`:** The external command-line tool that performs the actual data collection from vCenter.

* **`Jinja2`:** The templating engine used by FastAPI to render the `admin.html` page.

* **`configparser`:** For reading and writing `.ini` configuration files.

* **`subprocess`:** Python's standard library for running external commands (like `rvtools-python`).

* **`logging`:** Python's standard library for robust application logging.

## 5. Setup & Installation

This guide assumes you have [Podman](https://podman.io/docs/installation) (or Docker) installed on your system.

### Prerequisites

* Podman (or Docker)

* Python 3.9+ (for local development, though container handles most dependencies)

* A vCenter Server instance accessible from where the container will run.

### Clone the Repository

First, clone this project to your local machine:

git clone <repository-url>
cd <repository-directory>


### Create `app` Directory

Ensure your `main.py` is within an `app` directory. If your `main.py` is directly in the root, create an `app` directory and move `main.py` into it.

mkdir app
mv main.py app/


### Create `templates` Directory

Create a `templates` directory at the root level of your project for the `admin.html` file.

mkdir templates


### Create `requirements.txt`

Create a file named `requirements.txt` in the root of your project with the following content:

fastapi
uvicorn
pydantic
python-jose[cryptography]
passlib[bcrypt]
python-dotenv
python-multipart
pandas
rvtools-python
Jinja2


### Create `Dockerfile`

Create a file named `Dockerfile` in the root of your project with the following content:

Use a base image for Python 3.9 on Debian Bullseye
FROM python:3.9-slim-bullseye

Set the working directory in the container
WORKDIR /app

Install build dependencies for pandas, passlib[bcrypt] etc.
'build-essential' provides gcc, make, etc.
'python3-dev' provides Python development headers
'libffi-dev' and 'libssl-dev' are often needed by cryptographic packages
'git' might be needed if rvtools-python or other tools are installed from git
'curl' or 'wget' for downloading external resources if needed
RUN apt-get update &&

apt-get install -y --no-install-recommends

build-essential

python3-dev

libffi-dev

libssl-dev

git

curl &&

rm -rf /var/lib/apt/lists/*

Copy your requirements.txt file into the container
COPY requirements.txt .

Upgrade pip before installing dependencies for robustness
RUN pip install --no-cache-dir --upgrade pip

Install Python dependencies from requirements.txt
RUN pip install --no-cache-dir -r requirements.txt

Create a directory for rvtools-python config and output data
This directory will hold the config.ini and the collected CSVs
RUN mkdir -p /app/rvtools_data

Copy your application code into the container
This assumes your main.py is inside an 'app' subdirectory
e.g., your-project-folder/app/main.py
COPY . .

Expose the port your FastAPI app will run on
EXPOSE 8000

Command to run the application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]


### Create `.env` File

Create a file named `.env` in the root of your project. This file will store your JWT secret key.

SECRET_KEY="your-super-secret-key-please-change-this-in-production"

You can generate a strong secret key using:
python -c "import secrets; print(secrets.token_urlsafe(32))"

### Build the Podman Image

Navigate to the root directory of your project (where `Dockerfile`, `requirements.txt`, `app/`, and `templates/` are located) and build the container image:

podman build -t vmware-data-collector .


### Run the Podman Container

Run the container, mapping port 8000 from the container to port 8000 on your host. You also need to mount a volume for persistent storage of `config.ini` and the collected data. Replace `/path/to/your/local/data` with an actual path on your host machine.

podman run --rm -p 8000:8000 -v /path/to/your/local/data:/app/rvtools_data vmware-data-collector:latest


* `--rm`: Automatically remove the container when it exits.

* `-p 8000:8000`: Maps host port 8000 to container port 8000.

* `-v /path/to/your/local/data:/app/rvtools_data`: Mounts a local directory to `/app/rvtools_data` inside the container. This is crucial for `config.ini` and collected CSV/JSON data to persist.

## 6. How to Use the Tool

### Admin UI

Once the container is running, open your web browser and navigate to:

`http://localhost:8000/admin`

On this page, you can:

1. **Configure vCenter Credentials:**

   * Enter your vCenter Server URL (e.g., `https://your-vcenter.domain.com/sdk`).

   * Enter your vCenter Username and Password.

   * The `Output Directory` will default to `/app/rvtools_data` (the mounted volume inside the container).

   * Click "Save Configuration". This will write the details to `config.ini` inside the mounted volume.

2. **Collect Data:**

   * After saving the configuration, click "Collect Data Now".

   * This will trigger the FastAPI app to execute `rvtools-python` against your configured vCenter.

   * The collected data (CSVs) will be saved to the `/app/rvtools_data` directory, and then converted to JSON by the FastAPI app.

   * You'll see status messages on the page indicating the progress.

3. **View Application Logs:**

   * The right panel of the Admin UI displays real-time application logs.

   * Click "Refresh Logs" to fetch the latest log entries from `app.log`. This is useful for monitoring the data collection process and debugging.

4. **Architecture Explanation:**

   * Click the "Help" icon (question mark) in the top-right corner of the left panel.

   * An interactive modal will appear, explaining the application's architecture, components, design decisions, and process flow. Click on individual components to see detailed explanations.

### API Endpoints

The API documentation is available at:

`http://localhost:8000/docs` (Swagger UI)

Here you can explore and test the available API endpoints.

#### Authentication

All API endpoints (except `/token`) require OAuth2 Bearer Token authentication.

1. **Get a Token:**

   * Go to `http://localhost:8000/docs`.

   * Under the "Authentication" tag, expand the `/token` endpoint (POST method).

   * Click "Try it out".

   * Enter the `username` and `password`. For demonstration, you can use:

     * **Username:** `admin`

     * **Password:** `adminpass`

   * Click "Execute".

   * Copy the `access_token` from the response.

2. **Authorize API Calls:**

   * Click the "Authorize" button at the top right of the Swagger UI page.

   * In the "Value" field, enter `Bearer YOUR_ACCESS_TOKEN` (replace `YOUR_ACCESS_TOKEN` with the token you copied).

   * Click "Authorize" and then "Close".

Now you can try out the protected API endpoints.

#### Example Data Retrieval Endpoints:

* **`/vmware_data/{object_type}` (GET):**

  * Retrieves all data for a specific VMware object type (e.g., `vms`, `hosts`, `datastores`).

  * Example: `GET /vmware_data/vms`

* **`/vmware_data/{object_type}/{object_id}` (GET):**

  * Retrieves a single VMware object by its type and ID (UUID or Name).

  * Example: `GET /vmware_data/vms/your-vm-uuid` or `GET /vmware_data/vms/YourVMName`

Remember that the data served by these endpoints will be the data collected by `rvtools-python` and stored in your mounted `/app/rvtools_data` directory.

## 7. Troubleshooting

* **"CSV file for '...' not found"**:

  * Ensure your Podman volume mount is correct (`-v /path/to/your/local/data:/app/rvtools_data`).

  * Verify that `rvtools-python` successfully generated CSVs into the mounted local directory.

  * Check the `app.log` in the Admin UI for `rvtools-python` execution errors.

* **"Incorrect username or password"**:

  * Double-check the credentials used for the `/token` endpoint (`admin`/`adminpass` or `testuser1`/`password123`).

* **"Could not validate credentials"**:

  * Ensure you have correctly added the `Bearer YOUR_ACCESS_TOKEN` in the Swagger UI's "Authorize" dialog.

  * Your token might have expired (default 30 minutes). Obtain a new one.

* **"Unsupported markdown" in Mermaid flowchart**:

  * This indicates a rendering issue with the specific Mermaid renderer in your environment. The provided Mermaid syntax has been simplified to maximize compatibility. If it persists, the environment itself might not fully support Mermaid.

* **Container not starting**:

  * Check your `podman run` command for typos.

  * Review the `Dockerfile` for any installation errors during `podman build`.

  * Inspect container logs: `podman logs <container_id_or_name>`.
